<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elwyn AI</title>
  <meta name="theme-color" content="#7A1E2C" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ===== Design System & 10 Themes (same as before) ===== */
    :root{ --bg:#0f1317; --panel:#12181f; --text:#e9eef3; --muted:#a9b1bd; --line:#233041; --primary:#7A1E2C; --primary-2:#8F2A3A; --ok:#49d19a; --err:#ff8a8a; --elev:0 8px 24px rgba(0,0,0,.35); --radius:14px; --focus:#8ec9ff; }
    body[data-theme="classic"]{ --bg:#0f1317; --panel:#12181f; --text:#e9eef3; --muted:#a9b1bd; --line:#233041; --primary:#7A1E2C; --primary-2:#8F2A3A; }
    body[data-theme="midnight"]{ --bg:#0b0f14; --panel:#111622; --text:#dfe8f5; --muted:#9fb0c7; --line:#1e2b41; --primary:#2f6be0; --primary-2:#3a7bff; }
    body[data-theme="forest"]{ --bg:#0e1411; --panel:#121a16; --text:#e8f4ec; --muted:#a7c3b1; --line:#1c3327; --primary:#1f8a5b; --primary-2:#26a06a; }
    body[data-theme="ocean"]{ --bg:#0c1318; --panel:#101a22; --text:#e8f7ff; --muted:#a7c6d6; --line:#1f3442; --primary:#0fa3c9; --primary-2:#18b5dd; }
    body[data-theme="solar"]{ --bg:#0f1114; --panel:#151922; --text:#fff6e6; --muted:#e0cfa6; --line:#2c2a20; --primary:#ffb020; --primary-2:#ffc241; }
    body[data-theme="orchid"]{ --bg:#130f14; --panel:#1b141c; --text:#f8ecff; --muted:#d0b7de; --line:#2e2331; --primary:#b15bd4; --primary-2:#c778e7; }
    body[data-theme="slate"]{ --bg:#0f1113; --panel:#15181c; --text:#e8edf3; --muted:#b1bcc9; --line:#232a33; --primary:#5c7cff; --primary-2:#7791ff; }
    body[data-theme="sand"]{ --bg:#0f100f; --panel:#171814; --text:#f4efe6; --muted:#d8cfbe; --line:#2e2a20; --primary:#d6a15b; --primary-2:#e2b16c; }
    body[data-theme="rose"]{ --bg:#111014; --panel:#18161c; --text:#ffeef3; --muted:#e3c1cd; --line:#2e2331; --primary:#d6537a; --primary-2:#e06c90; }
    body[data-theme="contrast"]{ --bg:#000; --panel:#0e0e0e; --text:#fff; --muted:#cfd6df; --line:#2b2b2b; --primary:#00d18f; --primary-2:#25e0a7; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at -10% -10%, color-mix(in oklab, var(--panel) 40%, black) 0%, var(--bg) 60%) fixed;
    }
    .topbar{ background:linear-gradient(90deg,var(--primary) 0%,var(--primary-2) 100%); border-bottom:1px solid color-mix(in oklab, #fff 6%, transparent); position:sticky; top:0; z-index:5; }
    .wrap{ max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px }
    .brand{ display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none }
    .logo{ width:34px; height:34px; border-radius:8px; background:#fff; color:var(--primary); display:grid; place-items:center; font-weight:800; box-shadow:var(--elev) }

    .layout{ max-width:1200px; margin:20px auto; display:grid; grid-template-columns:280px 1fr; gap:18px; padding:0 16px }
    .side{ position:sticky; top:16px; align-self:start }
    .side-group{ background:color-mix(in oklab, var(--panel) 85%, transparent); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--elev); margin-bottom:12px }
    .side-title{ font-weight:700; margin-bottom:8px }
    .side-link{ width:100%; text-align:left; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:color-mix(in oklab, var(--panel) 70%, black 30%); color:var(--text); margin-bottom:8px; cursor:pointer; transition:.15s }
    .side-link.is-active,.side-link:hover{ background:color-mix(in oklab, var(--panel) 55%, var(--primary) 20%); border-color:color-mix(in oklab, var(--line) 70%, var(--primary) 30%) }

    .select,.engine{ width:100%; background:color-mix(in oklab, var(--panel) 85%, #000 15%); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; box-shadow:var(--elev); padding:16px }
    .muted{ color:var(--muted) }
    .grid{ display:grid; gap:12px }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ appearance:none; border:1px solid color-mix(in oklab, var(--line) 80%, #fff 0%); background:color-mix(in oklab, var(--panel) 85%, #000 15%); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; transition:.15s }
    .btn:hover{ background:color-mix(in oklab, var(--panel) 70%, var(--primary) 10%) } .btn.primary{ background:var(--primary); border-color:var(--primary-2) } .btn.primary:hover{ background:var(--primary-2) }
    textarea{ width:100%; background:color-mix(in oklab, var(--panel) 85%, #000 15%); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px; resize:vertical }
    .chat-log{ max-height:420px; overflow:auto; border:1px dashed color-mix(in oklab, var(--line) 90%, #000 10%); border-radius:12px; padding:12px; background:color-mix(in oklab, var(--panel) 75%, #000 25%) }
    .bubble{ padding:10px 12px; border-radius:12px; margin:8px 0; line-height:1.5; white-space:pre-wrap; animation:fade .12s ease }
    .bubble.user{ background:color-mix(in oklab, var(--panel) 70%, #000 30%); border:1px solid var(--line) }
    .bubble.assistant{ background:color-mix(in oklab, var(--primary) 18%, var(--panel) 82%); border:1px solid color-mix(in oklab, var(--primary) 35%, var(--line) 65%) }
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .panel{ display:none } .panel.is-visible{ display:block }
    .footer{ margin:30px 0; color:var(--muted); text-align:center }

    @media (max-width: 1000px){ .layout{ grid-template-columns: 1fr } .side{ position:static } }
  </style>
</head>

<body data-theme="classic">
  <!-- Top bar (status chip removed as requested) -->
  <header class="topbar">
    <div class="wrap">
      <a class="brand" href="#" aria-label="Elwyn Home">
        <div class="logo">E</div>
        <div><strong>Elwyn AI</strong></div>
      </a>
    </div>
  </header>

  <!-- Main -->
  <main class="layout">
    <!-- Sidebar -->
    <aside class="side">
      <div class="side-group">
        <div class="side-title">Tools</div>
        <!-- Theme + Model moved here -->
        <label class="muted tiny" for="themeSelect">Theme</label>
        <select id="themeSelect" class="select" aria-label="Choose theme">
          <option value="classic" selected>Classic (Burgundy)</option>
          <option value="midnight">Midnight</option>
          <option value="forest">Forest</option>
          <option value="ocean">Ocean</option>
          <option value="solar">Solar</option>
          <option value="orchid">Orchid</option>
          <option value="slate">Slate</option>
          <option value="sand">Sand</option>
          <option value="rose">Rose</option>
          <option value="contrast">High Contrast</option>
        </select>

        <label class="muted tiny" for="engineSelect" style="margin-top:8px;display:block">Model</label>
        <select id="engineSelect" class="engine" aria-label="Model">
          <option value="latest" selected>Latest (auto)</option>
          <option value="model-5-thinking">model-5-thinking</option>
          <option value="model-5">model-5</option>
          <option value="model-4o">model-4o</option>
          <option value="model-4o-mini">model-4o-mini</option>
        </select>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <button class="side-link is-active" data-view="chat">Chat</button>
        <button class="side-link" data-view="image">Text → Image</button>
        <button class="side-link" data-view="video">Text → Video (soon)</button>
        <button class="side-link" data-view="audio">Text → Audio (soon)</button>
        <button class="side-link" data-view="mission">Mission</button>
      </div>
    </aside>

    <!-- Views -->
   <section class="panel" data-panel="mission">
  <div class="card">
    <h2>Mission — Non-Profit Behavioral Health (AI-assisted, human-in-the-loop)</h2>
    <p class="muted">
      We deliver equitable behavioral care at scale with a hybrid model: models handle continuous monitoring, analysis,
      and immediate support; licensed clinicians lead complex therapy, crisis work, and individualized planning.
    </p>

    <!-- Strategic Pillars -->
    <div class="grid" style="gap:16px;margin-top:8px">
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">AI-Powered Assessment & Intake</h3>
        <ul class="muted" style="margin:0;display:grid;gap:6px">
          <li>Intelligent screening tools for preliminary behavioral assessments</li>
          <li>Risk stratification to prioritize high-need clients</li>
          <li>Automated crisis detection via speech/text/behavioral indicators</li>
          <li>Cultural-competency matching to pair clients with suitable providers</li>
        </ul>
      </div>
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">Remote Therapeutic Platforms</h3>
        <ul class="muted" style="margin:0;display:grid;gap:6px">
          <li>AI-enhanced teletherapy with real-time sentiment analysis & clinician prompts</li>
          <li>VR exposure therapy for phobias, PTSD, and anxiety</li>
          <li>Chatbot crisis counselors for 24/7 in-between-session support</li>
          <li>Adaptive therapy modules that adjust to engagement and progress</li>
        </ul>
      </div>
    </div>

    <div class="grid" style="gap:16px;margin-top:16px">
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">Personalized Treatment Planning</h3>
        <ul class="muted" style="margin:0;display:grid;gap:6px">
          <li>Evidence-based treatment matching from profile & outcomes data</li>
          <li>Dynamic plan adjustments from real-time progress monitoring</li>
          <li>Predictive relapse prevention — early warning for setbacks</li>
        </ul>
      </div>
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">Digital Engagement & Support</h3>
        <ul class="muted" style="margin:0;display:grid;gap:6px">
          <li>Mobile coaching for skills practice between sessions</li>
          <li>Automated check-ins & mood tracking with escalation protocols</li>
          <li>Peer support matching via shared experiences & compatibility</li>
          <li>Gamified interventions to increase engagement & retention</li>
        </ul>
      </div>
    </div>

    <div class="grid" style="gap:16px;margin-top:16px">
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">Operational Excellence</h3>
        <ul class="muted" style="margin:0;display:grid;gap:6px">
          <li>Smart scheduling optimizing provider–client matching & availability</li>
          <li>Automated documentation & progress-note generation</li>
          <li>Outcome dashboards for funders & stakeholders</li>
          <li>Multi-language support with real-time translation</li>
        </ul>
      </div>
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">Key Differentiator</h3>
        <p class="muted" style="margin:0">
          Hybrid human-AI care: models manage routine monitoring, data analysis, and immediate support;
          clinicians focus on therapeutic relationships, crisis intervention, and treatment planning.
          Always human-in-the-loop.
        </p>
      </div>
    </div>

    <!-- Detailed Tables -->
    <h3 style="margin-top:22px">I. Clinical & Direct Service Features</h3>
    <div class="row" style="justify-content:flex-end">
      <button class="btn tiny" data-export="#tbl-clinical">Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="table" id="tbl-clinical">
        <thead><tr><th>Feature</th><th>AI Mechanism</th><th>Non-Profit Value</th></tr></thead>
        <tbody>
          <tr>
            <td>24/7 Conversational AI Support</td>
            <td>NLP chatbots/virtual assistants trained in CBT/DBT-style skills.</td>
            <td>Immediate, low-barrier support beyond business hours; maximizes accessibility.</td>
          </tr>
          <tr>
            <td>Personalized Interventions</td>
            <td>ML on mood tracking + text/voice signals and progress data.</td>
            <td>Tailors exercises/resources to the user’s real-time state; improves outcomes.</td>
          </tr>
          <tr>
            <td>Early Crisis Detection & Escalation</td>
            <td>Sentiment & biomarker analysis for high-risk language/emotional shifts.</td>
            <td>Flags SI/high distress; triggers hotline, clinician connect, or emergency workflow.</td>
          </tr>
          <tr>
            <td>Remote Progress Monitoring</td>
            <td>Wearables/Health APIs (sleep, HRV, activity) + mood check-ins.</td>
            <td>Objective, continuous data for measurement-informed care and relapse tracking.</td>
          </tr>
          <tr>
            <td>Automated Clinical Documentation</td>
            <td>Consent-based ambient transcription; structured notes & summaries.</td>
            <td>Frees clinician time; consistent, higher-quality documentation.</td>
          </tr>
          <tr>
            <td>Diagnosis & Treatment Support</td>
            <td>Predictive analytics over history & assessments with evidence pathways.</td>
            <td>Faster, more accurate decisions; clinician retains final judgment.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3 style="margin-top:22px">II. Operational & Efficiency Features</h3>
    <div class="row" style="justify-content:flex-end">
      <button class="btn tiny" data-export="#tbl-ops">Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="table" id="tbl-ops">
        <thead><tr><th>Feature</th><th>AI Mechanism</th><th>Non-Profit Value</th></tr></thead>
        <tbody>
          <tr>
            <td>Workflow Automation</td>
            <td>RPA for scheduling, reminders, and follow-ups.</td>
            <td>Cuts administrative burden/costs; reduces burnout.</td>
          </tr>
          <tr>
            <td>Resource Optimization</td>
            <td>Predictive modeling for demand, staffing, and high-risk periods.</td>
            <td>Targets scarce resources to greatest need; prevents service gaps.</td>
          </tr>
          <tr>
            <td>Grant Writing & Reporting</td>
            <td>Generative models synthesize outcomes and draft proposals.</td>
            <td>Improves fundraising efficiency with low overhead.</td>
          </tr>
          <tr>
            <td>Custom Reporting Dashboards</td>
            <td>Automated visualizations of outcomes, equity, and finance KPIs.</td>
            <td>Demonstrates impact to board, donors, and regulators.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3 style="margin-top:22px">III. Non-Profit & Ethical Mandates</h3>
    <div class="row" style="justify-content:flex-end">
      <button class="btn tiny" data-export="#tbl-ethics">Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="table" id="tbl-ethics">
        <thead><tr><th>Feature</th><th>Description & Rationale</th></tr></thead>
        <tbody>
          <tr>
            <td>HIPAA/GDPR-Compliant Security</td>
            <td>End-to-end encryption, anonymization, and robust access controls for sensitive data.</td>
          </tr>
          <tr>
            <td>Equity & Bias Mitigation</td>
            <td>Diverse datasets; recurring algorithmic audits; fairness metrics across demographics.</td>
          </tr>
          <tr>
            <td>Cost-Sensitive Scalability</td>
            <td>Low variable cost per user to reach uninsured/underinsured communities at scale.</td>
          </tr>
          <tr>
            <td>Transparency & Human Oversight</td>
            <td>Human-in-the-loop; clear disclosures that users interact with AI; clinician has final say.</td>
          </tr>
          <tr>
            <td>Ethical Data Ownership</td>
            <td>User-owned data with granular consent & revocation; transparent retention/deletion.</td>
          </tr>
          <tr>
            <td>Intake Triage Bot</td>
            <td>Collects basics, screens for risk (SI/HI), and routes to an appropriate clinician.</td>
          </tr>
          <tr>
            <td>Safety Classifier</td>
            <td>Real-time risk flags in chat/calls with automated escalation playbooks.</td>
          </tr>
          <tr>
            <td>Clinician Copilot</td>
            <td>Draft notes, visit summaries, ICD-10/SNOMED suggestions, and after-visit plans.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3 style="margin-top:22px">Key Differentiator</h3>
    <p class="muted">
      A hybrid human-AI care model where models manage monitoring, analysis, and immediate support,
      while clinicians provide deep therapeutic relationships, crisis intervention, and treatment planning —
      maximizing reach and quality with an explicit human-in-the-loop guarantee.
    </p>
  </div>

  <!-- Self-contained CSV export helper for the three tables above -->
  <script>
    (function(){
      document.querySelectorAll('.btn.tiny[data-export]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const table = document.querySelector(btn.getAttribute('data-export'));
          if(!table) return;
          let csv = "";
          table.querySelectorAll("tr").forEach(tr=>{
            const cells = [...tr.children].map(td => `"${td.textContent.replace(/"/g,'""')}"`);
            csv += cells.join(",") + "\n";
          });
          const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = (table.id || "table") + ".csv";
          a.click();
          URL.revokeObjectURL(a.href);
        });
      });
    })();
  </script>
</section>


      <!-- Image -->
      <section class="panel" data-panel="image">
        <div class="card">
          <h2>Text → Image</h2>
          <form id="imgForm" class="grid">
            <textarea id="imgPrompt" rows="3" placeholder="Describe the image…"></textarea>
            <div class="row"><button class="btn primary" type="submit">Generate</button></div>
          </form>
          <div id="imgOut" class="grid"></div>
        </div>
      </section>

      <!-- Video placeholder -->
      <section class="panel" data-panel="video">
        <div class="card"><h2>Text → Video</h2><p class="muted">Coming soon.</p></div>
      </section>

      <!-- Audio placeholder -->
      <section class="panel" data-panel="audio">
        <div class="card"><h2>Text → Audio</h2><p class="muted">Coming soon.</p></div>
      </section>

      <!-- Mission (unchanged content from previous message, trimmed here for brevity) -->
      <section class="panel" data-panel="mission">
        <div class="card">
          <h2>Mission — Non-Profit Behavioral Health (AI-assisted, human-in-the-loop)</h2>
          <p class="muted">Hybrid human-AI care model…</p>

          <!-- (Keep your tables and differentiator here — omitted to reduce message size.
               If you want, I can re-paste the full Mission tables again.) -->
          <p class="muted">See previous section for full feature tables. (I can reinsert here if needed.)</p>
        </div>
      </section>
    </section>
  </main>

  <footer class="footer">© 2025 Elwyn AI</footer>

  <script>
    const VERSION = "ui-v4-tools";
    const WORKER_URL = "/api";
    const DEFAULT_MODEL = "latest";
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>[...document.querySelectorAll(s)];
    const currentModel = ()=> $("#engineSelect")?.value || DEFAULT_MODEL;

    // Theme persistence
    const themeSelect = $("#themeSelect");
    const savedTheme = localStorage.getItem("elwyn:theme");
    if(savedTheme){ document.body.setAttribute("data-theme", savedTheme); themeSelect.value = savedTheme; }
    themeSelect?.addEventListener("change", ()=>{ const t=themeSelect.value; document.body.setAttribute("data-theme", t); localStorage.setItem("elwyn:theme", t); });

    // Sidebar switching
    (()=>{
      const view = $("#view"), links = $$(".side-link");
      function show(name){
        view.querySelectorAll(".panel").forEach(p=>p.classList.remove("is-visible"));
        view.querySelector('[data-panel="'+name+'"]')?.classList.add("is-visible");
        links.forEach(b=>b.classList.toggle("is-active", b.dataset.view===name));
        window.scrollTo({ top:0, behavior:"smooth" });
      }
      links.forEach(b=>b.addEventListener("click", ()=>show(b.dataset.view)));
    })();

    // -------- Chat with simple tool routing --------
    (()=>{
      const log=$("#chatLog"), form=$("#chatForm"), box=$("#chatBox");
      if(!log||!form||!box) return;

      const hist = JSON.parse(localStorage.getItem("elwyn:chat")||"[]");
      const add = (role,text)=>{ const d=document.createElement("div"); d.className="bubble "+(role==="user"?"user":"assistant"); d.textContent=text; log.appendChild(d); log.scrollTop=log.scrollHeight; };
      const save=()=> localStorage.setItem("elwyn:chat", JSON.stringify(hist));
      hist.forEach(m=>add(m.role,m.content));
      $("#clearChat")?.addEventListener("click",()=>{ localStorage.removeItem("elwyn:chat"); log.innerHTML=""; });

      function looksLikeWeather(q){ return /\b(weather|forecast|temperature|climate)\b/i.test(q); }
      function looksLikeTime(q){ return /\b(time|date|day|calendar|now)\b/i.test(q); }
      function looksLikeSearch(q){ return /\b(news|current affairs|who is|what is|search|latest)\b/i.test(q); }

      async function callTool(kind, query){
        try{
          if(kind==="time"){
            const r = await fetch(`${WORKER_URL}/v1/time`, {cache:"no-store"});
            const j = await r.json();
            return j.ok ? `⏰ Time now: ${j.display}${j.city?` — ${j.city}, ${j.country||""}`:""} (TZ: ${j.timezone})` : "Time lookup failed.";
          }
          if(kind==="weather"){
            // If user typed "in Lagos", we could geocode, but to avoid extra APIs we rely on CF geolocation.
            const r = await fetch(`${WORKER_URL}/v1/weather`, {cache:"no-store"});
            const j = await r.json();
            if(!j.ok) return "Weather lookup failed.";
            const c = j.current||{};
            return `🌤 Weather: ${c.temp_c ?? "?"}°C, wind ${c.wind_speed ?? "?"} m/s, precip ${c.precipitation_mm ?? 0} mm (tz: ${j.where?.timezone||"auto"})`;
          }
          if(kind==="search"){
            const r = await fetch(`${WORKER_URL}/v1/search?q=`+encodeURIComponent(query), {cache:"no-store"});
            const j = await r.json();
            if(!j.ok) return "Web search failed.";
            return `🔎 ${j.summary || "No summary found."}${j.url?`\n\nMore: ${j.url}`:""}`;
          }
        }catch(e){ return "Tool error: "+(e?.message||e); }
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const text=(box.value||"").trim(); if(!text) return;
        box.value=""; hist.push({role:"user",content:text}); add("user",text); save();

        const thinking=document.createElement("div"); thinking.className="bubble assistant"; thinking.textContent="…thinking…";
        log.appendChild(thinking); log.scrollTop=log.scrollHeight;

        // Tool routing first
        try{
          let toolAns = null;
          if(looksLikeTime(text))       toolAns = await callTool("time", text);
          else if(looksLikeWeather(text)) toolAns = await callTool("weather", text);
          else if(looksLikeSearch(text))  toolAns = await callTool("search", text);

          if(toolAns){
            thinking.remove();
            hist.push({role:"assistant",content:toolAns}); save(); add("assistant", toolAns);
            return;
          }
        }catch{}

        // Otherwise, go to model chat
        try{
          const r = await fetch(`${WORKER_URL}/v1/chat`, {
            method:"POST", headers:{ "content-type":"application/json" },
            body: JSON.stringify({ model: currentModel(), messages: hist })
          });
          const j = await r.json().catch(()=>({}));
          const extra = j.modelUsed ? `\n\n— via ${j.modelUsed}` : "";
          const reply = (j.reply||"(no reply)")+extra;
          thinking.remove(); hist.push({role:"assistant",content:reply}); save(); add("assistant", reply);
        }catch(err){
          thinking.remove(); add("assistant","Server error: "+(err?.message||err));
        }
      });
    })();

    // -------- Text → Image --------
    (()=>{
      const form=$("#imgForm"), input=$("#imgPrompt"), out=$("#imgOut");
      if(!form||!input||!out) return;
      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const p=(input.value||"").trim(); if(!p) return;
        out.innerHTML = '<div class="muted">Generating…</div>';
        try{
          const r = await fetch(`${WORKER_URL}/v1/image`, {
            method:"POST", headers:{ "content-type":"application/json" },
            body: JSON.stringify({ prompt:p, size:"1024x1024" })
          });
          const j = await r.json().catch(()=>({}));
          if (j?.ok && j.image_b64) {
            const img=new Image(); img.src="data:image/png;base64,"+j.image_b64; img.alt="generated image"; img.style.width="100%";
            out.innerHTML=""; out.appendChild(img);
          } else {
            out.innerHTML = `<span class="muted">Error: ${j?.error||"failed"}</span>`;
          }
        }catch(err){ out.innerHTML = `<span class="muted">Server error: ${(err?.message||err)}</span>`; }
      });
    })();
  </script>
</body>
</html>
