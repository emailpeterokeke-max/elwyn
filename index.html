<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elwyn AI</title>
  <meta name="theme-color" content="#7A1E2C" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1317; --panel:#12181f; --text:#e9eef3; --muted:#a9b1bd; --line:#233041; --primary:#7A1E2C; --primary-2:#8F2A3A; --ok:#49d19a; --err:#ff8a8a; --elev:0 8px 24px rgba(0,0,0,.35); --radius:14px }
    body[data-theme="classic"]{ --bg:#0f1317; --panel:#12181f; --text:#e9eef3; --muted:#a9b1bd; --line:#233041; --primary:#7A1E2C; --primary-2:#8F2A3A }
    body[data-theme="midnight"]{ --bg:#0b0f14; --panel:#111622; --text:#dfe8f5; --muted:#9fb0c7; --line:#1e2b41; --primary:#2f6be0; --primary-2:#3a7bff }
    body[data-theme="forest"]{ --bg:#0e1411; --panel:#121a16; --text:#e8f4ec; --muted:#a7c3b1; --line:#1c3327; --primary:#1f8a5b; --primary-2:#26a06a }
    body[data-theme="ocean"]{ --bg:#0c1318; --panel:#101a22; --text:#e8f7ff; --muted:#a7c6d6; --line:#1f3442; --primary:#0fa3c9; --primary-2:#18b5dd }
    body[data-theme="solar"]{ --bg:#0f1114; --panel:#151922; --text:#fff6e6; --muted:#e0cfa6; --line:#2c2a20; --primary:#ffb020; --primary-2:#ffc241 }
    body[data-theme="orchid"]{ --bg:#130f14; --panel:#1b141c; --text:#f8ecff; --muted:#d0b7de; --line:#2e2331; --primary:#b15bd4; --primary-2:#c778e7 }
    body[data-theme="slate"]{ --bg:#0f1113; --panel:#15181c; --text:#e8edf3; --muted:#b1bcc9; --line:#232a33; --primary:#5c7cff; --primary-2:#7791ff }
    body[data-theme="sand"]{ --bg:#0f100f; --panel:#171814; --text:#f4efe6; --muted:#d8cfbe; --line:#2e2a20; --primary:#d6a15b; --primary-2:#e2b16c }
    body[data-theme="rose"]{ --bg:#111014; --panel:#18161c; --text:#ffeef3; --muted:#e3c1cd; --line:#2e2331; --primary:#d6537a; --primary-2:#e06c90 }
    body[data-theme="contrast"]{ --bg:#000; --panel:#0e0e0e; --text:#fff; --muted:#cfd6df; --line:#2b2b2b; --primary:#00d18f; --primary-2:#25e0a7 }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at -10% -10%, color-mix(in oklab, var(--panel) 40%, black) 0%, var(--bg) 60%) fixed;}
    .topbar{background:linear-gradient(90deg,var(--primary) 0%,var(--primary-2) 100%);border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;z-index:5}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    .logo{width:34px;height:34px;border-radius:8px;background:#fff;color:var(--primary);display:grid;place-items:center;font-weight:800;box-shadow:var(--elev)}
    .layout{max-width:1200px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:18px;padding:0 16px}
    .side{position:sticky;top:16px;align-self:start}
    .side-group{background:color-mix(in oklab, var(--panel) 85%, transparent);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--elev);margin-bottom:12px}
    .side-title{font-weight:700;margin-bottom:8px}
    .side-link{width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:color-mix(in oklab, var(--panel) 70%, black 30%);color:var(--text);margin-bottom:8px;cursor:pointer;transition:.15s}
    .side-link.is-active,.side-link:hover{background:color-mix(in oklab, var(--panel) 55%, var(--primary) 20%);
      border-color:color-mix(in oklab, var(--line) 70%, var(--primary) 30%)}
    .select,.engine{width:100%;background:color-mix(in oklab, var(--panel) 85%, #000 15%);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--elev);padding:16px}
    .muted{color:var(--muted)} .grid{display:grid;gap:12px} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid color-mix(in oklab, var(--line) 80%, #fff 0%);background:color-mix(in oklab, var(--panel) 85%, #000 15%);
      color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{background:color-mix(in oklab, var(--panel) 70%, var(--primary) 10%)} .btn.primary{background:var(--primary);border-color:var(--primary-2)}
    .btn.primary:hover{background:var(--primary-2)} .btn.tiny{padding:6px 10px;font-size:12px;border-radius:999px}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,.08);border:1px solid var(--line);margin-left:6px}
    textarea{width:100%;background:color-mix(in oklab, var(--panel) 85%, #000 15%);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px;resize:vertical}
    .chat-log{max-height:420px;overflow:auto;border:1px dashed color-mix(in oklab, var(--line) 90%, #000 10%);border-radius:12px;padding:12px;background:color-mix(in oklab, var(--panel) 75%, #000 25%)}
    .bubble{padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.5;white-space:pre-wrap;animation:fade .12s ease;overflow-wrap:anywhere}
    .bubble.user{background:color-mix(in oklab, var(--panel) 70%, #000 30%);border:1px solid var(--line)}
    .bubble.assistant{background:color-mix(in oklab, var(--primary) 18%, var(--panel) 82%);border:1px solid color-mix(in oklab, var(--primary) 35%, var(--line) 65%)}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .panel{display:none}.panel.is-visible{display:block}
    .footer{margin:30px 0;color:var(--muted);text-align:center}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}.side{position:static}}
  </style>
</head>

<body data-theme="classic">
  <header class="topbar">
    <div class="wrap">
      <a class="brand" href="#" aria-label="Elwyn Home">
        <div class="logo">E</div>
        <div><strong>Elwyn AI</strong></div>
      </a>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT: Nav -->
    <aside class="side">
      <div class="side-group">
        <div class="side-title">Navigate</div>
        <button class="side-link is-active" data-view="chat">Chat</button>
        <button class="side-link" data-view="image">Text ‚Üí Image</button>
        <button class="side-link" data-view="video">Text ‚Üí Video (soon)</button>
        <button class="side-link" data-view="audio">Text ‚Üí Audio (soon)</button>
        <button class="side-link" data-view="mission">Mission</button>
      </div>

      <div class="side-group">
        <div class="side-title">Programs</div>
        <button class="side-link" data-view="therapy">Therapy ‚Äî AI-Assisted Online <span class="badge">Soon</span></button>
        <button class="side-link" data-view="counseling">Counseling ‚Äî AI-Assisted Online <span class="badge">Soon</span></button>
        <button class="side-link" data-view="assessment">Assessment ‚Äî Remote, AI-Guided <span class="badge">Soon</span></button>
        <button class="side-link" data-view="safety">Safety Plan ‚Äî Digital Plan with AI Support <span class="badge">Soon</span></button>
        <button class="side-link" data-view="giving">Giving Elwyn ‚Äî Support ¬∑ Donate ¬∑ Sponsor Care</button>
      </div>

      <div class="side-group">
        <div class="side-title">Tools</div>
        <label class="muted tiny" for="themeSelect">Theme</label>
        <select id="themeSelect" class="select" aria-label="Choose theme">
          <option value="classic" selected>Classic (Burgundy)</option>
          <option value="midnight">Midnight</option>
          <option value="forest">Forest</option>
          <option value="ocean">Ocean</option>
          <option value="solar">Solar</option>
          <option value="orchid">Orchid</option>
          <option value="slate">Slate</option>
          <option value="sand">Sand</option>
          <option value="rose">Rose</option>
          <option value="contrast">High Contrast</option>
        </select>

        <label class="muted tiny" for="engineSelect" style="margin-top:8px;display:block">Model</label>
        <select id="engineSelect" class="engine" aria-label="Model">
          <option value="latest">Latest (auto)</option>
          <option value="model-5-thinking" selected>model-5-thinking</option>
          <option value="model-5">model-5</option>
          <option value="model-4o">model-4o</option>
          <option value="model-4o-mini">model-4o-mini</option>
        </select>
      </div>
    </aside>

    <!-- RIGHT: Views -->
    <section id="view" class="grid">

      <!-- Chat -->
      <section class="panel is-visible" data-panel="chat">
        <div class="card">
          <h2>Ask Elwyn AI</h2>
          <p class="muted">Smart chat with built-in tools for time, weather, and web/news lookups.</p>
          <div class="grid">
            <div id="chatLog" class="chat-log" aria-live="polite"></div>
            <form id="chatForm" class="grid">
              <label class="muted" for="chatBox" style="display:flex;align-items:center;gap:6px">
                <span style="font-weight:700">Ask Anything</span> <span aria-hidden="true">‚Üí</span>
              </label>
              <textarea id="chatBox" rows="4" placeholder='Try: "time in London", "weather in Lagos", "latest news on AI safety"'></textarea>
              <div class="row">
                <button class="btn primary" type="submit">Send</button>
                <button class="btn" type="button" id="clearChat">Clear</button>
                <button class="btn" type="button" id="useMyLocation" title="Use device location for time & weather">Use my location</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Text ‚Üí Image -->
      <section class="panel" data-panel="image">
        <div class="card">
          <h2>Text ‚Üí Image</h2>
          <form id="imgForm" class="grid">
            <textarea id="imgPrompt" rows="3" placeholder="Describe the image‚Ä¶"></textarea>
            <div class="row"><button class="btn primary" type="submit">Generate</button></div>
          </form>
          <div id="imgOut" class="grid"></div>
        </div>
      </section>

      <!-- Video -->
      <section class="panel" data-panel="video">
        <div class="card"><h2>Text ‚Üí Video <span class="badge">Soon</span></h2><p class="muted">Coming soon.</p></div>
      </section>

      <!-- Audio -->
      <section class="panel" data-panel="audio">
        <div class="card"><h2>Text ‚Üí Audio <span class="badge">Soon</span></h2><p class="muted">Coming soon.</p></div>
      </section>

      <!-- Mission (FULL CONTENT) -->
      <section class="panel" data-panel="mission">
        <div class="card">
          <style>
            .mission h2,.mission h3{margin:0 0 10px 0}.mission h4{margin:16px 0 8px 0}.mission p{margin:6px 0 10px 0}
            .mission .muted{color:var(--muted)}
            .mission .note{padding:12px;border:1px dashed var(--line);border-radius:10px;background:color-mix(in oklab,var(--panel) 85%,#000 15%);margin:10px 0 16px}
            .mission .grid-2{display:grid;gap:14px;grid-template-columns:1fr 1fr}
            @media (max-width:900px){.mission .grid-2{grid-template-columns:1fr}}
            .mission table{width:100%;border-collapse:collapse;margin:10px 0 16px 0;background:color-mix(in oklab,var(--panel) 90%,#000 10%);border:1px solid var(--line);border-radius:12px;overflow:hidden}
            .mission th,.mission td{text-align:left;padding:10px 12px;vertical-align:top;border-bottom:1px solid var(--line)}
            .mission th{background:color-mix(in oklab,var(--panel) 70%,var(--primary) 10%);font-weight:700}
            .mission tr:last-child td{border-bottom:none}
            .mission ul{margin:6px 0 12px 18px}.mission .small{font-size:12px}
          </style>
          <div class="mission">
            <h2>Mission ‚Äî Non-Profit Behavioral Health (AI-assisted, human-in-the-loop)</h2>
            <p class="muted">We expand access to high-quality behavioral health services by pairing models for continuous monitoring and instant support with licensed clinicians for complex therapy, crisis intervention, and individualized planning. AI assists; clinicians lead.</p>
            <div class="note"><strong>Key Differentiator:</strong> Hybrid human-AI care model where AI handles routine monitoring, data analysis, and immediate support, while human clinicians focus on complex therapeutic relationships, crisis intervention, and treatment planning. This allows wider reach with maintained quality and safety.</div>

            <h3>Program Pillars</h3>
            <div class="grid-2">
              <div>
                <h4>AI-Powered Assessment & Intake</h4>
                <ul>
                  <li>Intelligent screening tools that conduct preliminary behavioral assessments.</li>
                  <li>Risk stratification algorithms that prioritize high-need clients.</li>
                  <li>Automated crisis detection via speech, text, or behavioral indicators.</li>
                  <li>Cultural-competency matching to pair clients with appropriate providers.</li>
                </ul>

                <h4>Remote Therapeutic Platforms</h4>
                <ul>
                  <li>AI-enhanced teletherapy with real-time sentiment analysis and intervention suggestions.</li>
                  <li>Virtual reality exposure therapy for phobias, PTSD, and anxiety disorders.</li>
                  <li>Chatbot crisis counselors for 24/7 immediate support between sessions.</li>
                  <li>Adaptive therapy modules that adjust to client progress and engagement.</li>
                </ul>
              </div>
              <div>
                <h4>Personalized Treatment Planning</h4>
                <ul>
                  <li>Evidence-based treatment matching from client profile and outcomes data.</li>
                  <li>Dynamic treatment adjustment based on real-time progress monitoring.</li>
                  <li>Predictive relapse prevention to identify warning signs early.</li>
                </ul>

                <h4>Digital Engagement & Support</h4>
                <ul>
                  <li>Mobile apps with AI coaching for practice between sessions.</li>
                  <li>Automated check-ins and mood tracking with escalation protocols.</li>
                  <li>Peer support matching by shared experiences and compatibility.</li>
                  <li>Gamified behavioral interventions to increase engagement.</li>
                </ul>

                <h4>Operational Excellence</h4>
                <ul>
                  <li>Smart scheduling to optimize provider-client matching and availability.</li>
                  <li>Automated documentation and progress-note generation.</li>
                  <li>Outcome-tracking dashboards for funders and stakeholders.</li>
                  <li>Multi-language support with real-time translation.</li>
                </ul>
              </div>
            </div>

            <h3>I. Clinical &amp; Direct Service Features</h3>
            <p class="muted">Features that directly improve care quality and access in remote settings.</p>
            <table>
              <thead><tr><th style="width:28%">Feature</th><th style="width:34%">AI Mechanism</th><th>Non-Profit Value</th></tr></thead>
              <tbody>
                <tr><td>24/7 Conversational AI Support</td><td>NLP chatbots/virtual assistants trained in CBT/DBT.</td><td>Immediate, low-barrier support outside business hours to maximize accessibility.</td></tr>
                <tr><td>Personalized Interventions</td><td>ML analyzes mood tracking, text/voice patterns, and progress data.</td><td>Tailors resources to the person‚Äôs real-time state for higher treatment relevance.</td></tr>
                <tr><td>Early Crisis Detection &amp; Escalation</td><td>Sentiment analysis &amp; vocal biomarkers detect high-risk language/shifts.</td><td>Flags suicidal ideation/high distress and triggers playbooks (hotline, clinician connect, alerts).</td></tr>
                <tr><td>Remote Progress Monitoring</td><td>Wearables/health APIs (sleep, HRV, activity) + mood diaries.</td><td>Objective, continuous data enables measurement-informed care and relapse tracking.</td></tr>
                <tr><td>Automated Clinical Documentation</td><td>Ambient transcription + structuring during sessions (with consent).</td><td>Drafts notes, summaries, and plans so clinicians can focus on care.</td></tr>
                <tr><td>Diagnosis &amp; Treatment Support</td><td>Predictive analytics over history, assessments, and behavior patterns.</td><td>Assists clinicians with likely diagnoses and evidence-aligned interventions.</td></tr>
              </tbody>
            </table>

            <h3>II. Operational &amp; Efficiency Features</h3>
            <p class="muted">Capabilities that stretch limited resources and increase reach.</p>
            <table>
              <thead><tr><th style="width:28%">Feature</th><th style="width:34%">AI Mechanism</th><th>Non-Profit Value</th></tr></thead>
              <tbody>
                <tr><td>Workflow Automation</td><td>RPA for scheduling, reminders, and follow-ups.</td><td>Reduces admin burden and costs; helps prevent staff burnout.</td></tr>
                <tr><td>Resource Optimization</td><td>Predictive modeling for demand, staffing, and high-risk periods.</td><td>Targets scarce therapist time and funds where need is greatest.</td></tr>
                <tr><td>Grant Writing &amp; Reporting</td><td>Generative AI drafts impact reports and tailored proposals.</td><td>Improves fundraising efficiency with lower overhead.</td></tr>
                <tr><td>Customizable Reporting Dashboards</td><td>Automated data pipelines and visualization.</td><td>Real-time outcomes for boards, donors, and regulators.</td></tr>
              </tbody>
            </table>

            <h3>III. Non-Profit &amp; Ethical Mandates</h3>
            <p class="muted">Foundational policies for safe, equitable care at scale.</p>
            <table>
              <thead><tr><th style="width:32%">Feature</th><th>Description &amp; Rationale</th></tr></thead>
              <tbody>
                <tr><td>HIPAA/GDPR-Compliant Security</td><td>End-to-end encryption, data minimization/anonymization, and robust access controls. Strict privacy compliance is non-negotiable for mental-health data.</td></tr>
                <tr><td>Equity &amp; Bias Mitigation</td><td>Diverse datasets, continuous fairness auditing, and outcome reviews to avoid perpetuating disparities across demographic groups.</td></tr>
                <tr><td>Cost-Sensitive Scalability</td><td>Architecture designed for high volume at low variable cost to serve uninsured/underinsured communities.</td></tr>
                <tr><td>Transparency &amp; Human Oversight</td><td>Human-in-the-loop by design: clinicians have final say; users are informed when interacting with AI.</td></tr>
                <tr><td>Ethical Data Ownership</td><td>Clear policies granting users control over their behavioral-health data: consent, portability, and deletion pathways.</td></tr>
              </tbody>
            </table>

            <h3>Clinical Safety &amp; Operations Utilities</h3>
            <ul>
              <li><strong>Intake triage bot</strong>: collects demographics &amp; concerns, screens for risk (SI/HI), routes to appropriate clinician.</li>
              <li><strong>Safety classifier</strong>: real-time risk flags in chat/calls; auto-escalation playbooks and notifications.</li>
              <li><strong>Clinician copilot</strong>: drafts notes, visit summaries, ICD-10/SNOMED suggestions, and after-visit plans.</li>
            </ul>
            <p class="small muted">AI-assisted care is always human-in-the-loop. For emergencies, call local emergency services (e.g., 911 in the U.S. or your regional equivalent).</p>
          </div>
        </div>
      </section>

      <!-- Programs (exact wording) -->
      <section class="panel" data-panel="therapy">
        <div class="card">
          <h2>Therapy ‚Äî AI-Assisted Online <span class="badge">Soon</span></h2>
          <p>Human-led therapy delivered by licensed clinicians via video, phone, or chat‚Äîenhanced by an AI copilot for faster notes and tailored exercises.</p>
          <ul>
            <li>Fast remote access, multilingual support, low-bandwidth mode, clear goals (CBT/DBT).</li>
            <li>Auto-drafted notes, care-plan templates, supervision-ready summaries, consistent outcomes tracking.</li>
          </ul>
          <p class="muted"><strong>Disclosure:</strong> AI assists clinicians; it never diagnoses or replaces clinical judgment.</p>
          <div class="row"><button class="btn" disabled>Start Therapy (coming soon)</button></div>
        </div>
      </section>

      <section class="panel" data-panel="counseling">
        <div class="card">
          <h2>Counseling ‚Äî AI-Assisted Online <span class="badge">Soon</span></h2>
          <p>Brief, skills-focused sessions for day-to-day challenges, with clinician review and AI-assisted summaries.</p>
          <ul>
            <li>Quick starts, practical tools, flexible chat/video.</li>
            <li>Standardized short-form notes, resource links, simple escalation to Therapy when needed.</li>
          </ul>
          <div class="row"><button class="btn" disabled>Book Counseling (coming soon)</button></div>
        </div>
      </section>

      <section class="panel" data-panel="assessment">
        <div class="card">
          <h2>Assessment ‚Äî Remote, AI-Guided <span class="badge">Soon</span></h2>
          <p>Clinician-reviewed intake with evidence-based screeners (e.g., PHQ-9, GAD-7, C-SSRS). AI prompts ensure completeness; clinicians confirm results.</p>
          <ul>
            <li>Faster onboarding, clear next steps, language accessibility.</li>
            <li>Fewer admin gaps, consistent documentation, smarter triage and referrals.</li>
          </ul>
          <div class="row"><button class="btn" disabled>Start Assessment (coming soon)</button></div>
        </div>
      </section>

      <section class="panel" data-panel="safety">
        <div class="card">
          <h2>Safety Plan ‚Äî Digital Plan with AI Support <span class="badge">Soon</span></h2>
          <p>Create, update, and share a personal safety plan‚Äîwarning signs, coping steps, supports, crisis options. AI reminders help keep it current; clinicians approve.</p>
          <ul>
            <li>One-tap share with family/providers, gentle check-ins, export to PDF.</li>
            <li>Templates, version history, approvals, audit-ready logs.</li>
          </ul>
          <p class="muted"><strong>Emergency:</strong> Call 911 or 988. This tool does not replace emergency services.</p>
          <div class="row"><button class="btn" disabled>Create Safety Plan (coming soon)</button></div>
        </div>
      </section>

      <section class="panel" data-panel="giving">
        <div class="card">
          <h2>Giving (Elwyn) ‚Äî Support ¬∑ Donate ¬∑ Sponsor Care</h2>
          <p>Power access to therapy, assessments, and safety plans for families in need.</p>
          <ul>
            <li>One-time gifts, monthly giving, or sponsor sessions; impact updates.</li>
            <li>Employer match, volunteer options, transparent reporting and receipts.</li>
          </ul>
          <div class="row">
            <button class="btn primary" disabled>Donate (coming soon)</button>
            <button class="btn" disabled>Sponsor a Session (coming soon)</button>
            <button class="btn" disabled>Volunteer (coming soon)</button>
          </div>
        </div>
      </section>

    </section>
  </main>

  <footer class="footer">¬© 2025 Elwyn AI</footer>

  <script>
    // === CONFIG ===
    const WORKER_URL = "/api";
    const DEFAULT_MODEL = "model-5-thinking";
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>[...document.querySelectorAll(s)];
    const currentModel = ()=> $("#engineSelect")?.value || DEFAULT_MODEL;

    // Theme persistence
    (()=>{
      const sel=$("#themeSelect"); const saved=localStorage.getItem("elwyn:theme");
      if(saved){ document.body.setAttribute("data-theme", saved); if(sel) sel.value=saved; }
      sel?.addEventListener("change", ()=>{ const t=sel.value; document.body.setAttribute("data-theme", t); localStorage.setItem("elwyn:theme", t); });
    })();

    // Geolocation cache (for weather/time)
    const geoKey = "elwyn:geo";
    async function updateGeoFromDevice(){
      if(!("geolocation" in navigator)) return null;
      return new Promise((resolve)=> {
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ 
            const g={ lat:pos.coords.latitude, lon:pos.coords.longitude, ts:Date.now() };
            localStorage.setItem(geoKey, JSON.stringify(g)); resolve(g);
          },
          ()=>resolve(null),
          { enableHighAccuracy:false, timeout:8000, maximumAge:300000 }
        );
      });
    }
    $("#useMyLocation")?.addEventListener("click", updateGeoFromDevice);

    // Sidebar switching
    (()=>{
      const view=$("#view"), links=$$(".side-link");
      function show(name){
        view.querySelectorAll(".panel").forEach(p=>p.classList.remove("is-visible"));
        view.querySelector(`[data-panel="${name}"]`)?.classList.add("is-visible");
        links.forEach(b=>b.classList.toggle("is-active", b.dataset.view===name));
        window.scrollTo({ top:0, behavior:"smooth" });
      }
      links.forEach(b=>b.addEventListener("click", ()=>show(b.dataset.view)));
    })();

    // Helpers to detect tools
    const looksLikeWeather = (q)=> /\b(weather|forecast|temperature|climate)\b/i.test(q);
    const looksLikeTime    = (q)=> /\b(time|date|day|calendar|now)\b/i.test(q);
    const looksLikeNews    = (q)=> /\b(news|headlines|latest|breaking|current affairs)\b/i.test(q);
    const looksLikeSearch  = (q)=> /\b(who is|what is|search)\b/i.test(q);
    const extractPlace = (q)=> (q.match(/\b(?:in|at|for)\s+([A-Za-z\s'.-]{2,})$/i)?.[1] || "").trim();
    const escapeHTML = (s)=> String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    // Geocode through worker
    async function geocode(place){
      const r = await fetch(`${WORKER_URL}/v1/geocode?q=${encodeURIComponent(place)}`, {cache:"no-store"});
      const j = await r.json().catch(()=>null);
      return j?.ok ? j : null;
    }

    // Chat + tools
    (()=>{
      const log=$("#chatLog"), form=$("#chatForm"), box=$("#chatBox");
      if(!log||!form||!box) return;

      const hist = JSON.parse(localStorage.getItem("elwyn:chat")||"[]");
      const add = (role,text)=>{ const d=document.createElement("div"); d.className="bubble "+(role==="user"?"user":"assistant"); d.textContent=text; log.appendChild(d); log.scrollTop=log.scrollHeight; };
      const addHTML = (role,html)=>{ const d=document.createElement("div"); d.className="bubble "+(role==="user"?"user":"assistant"); d.innerHTML=html; log.appendChild(d); log.scrollTop=log.scrollHeight; };
      const save = ()=> localStorage.setItem("elwyn:chat", JSON.stringify(hist));
      hist.forEach(m=>add(m.role, m.content));

      $("#clearChat")?.addEventListener("click",()=>{ localStorage.removeItem("elwyn:chat"); log.innerHTML=""; });

      async function callTime(q){
        const place = extractPlace(q);
        const tz = !place ? (Intl.DateTimeFormat().resolvedOptions().timeZone || undefined) : undefined;
        const params = new URLSearchParams();
        if (place) {
          const g = await geocode(place);
          if (g) { params.set("q", place); params.set("lat", g.lat); params.set("lon", g.lon); }
          else { params.set("q", place); }
        } else {
          const geo = JSON.parse(localStorage.getItem(geoKey)||"null");
          if (tz) params.set("tz", tz);
          if (geo?.lat && geo?.lon) { params.set("lat", geo.lat); params.set("lon", geo.lon); }
        }
        const r = await fetch(`${WORKER_URL}/v1/time?${params.toString()}`, {cache:"no-store"});
        const j = await r.json();
        return j.ok ? `‚è∞ ${j.display}${j.city?` ‚Äî ${j.city}`:""} (TZ: ${j.timezone})` : "Time lookup failed.";
      }

      async function callWeather(q){
        const place = extractPlace(q);
        let url;
        if (place) {
          const g = await geocode(place);
          if (g) url = `${WORKER_URL}/v1/weather?lat=${encodeURIComponent(g.lat)}&lon=${encodeURIComponent(g.lon)}`;
        }
        if (!url) {
          const geo = JSON.parse(localStorage.getItem(geoKey)||"null");
          url = (geo?.lat && geo?.lon)
            ? `${WORKER_URL}/v1/weather?lat=${encodeURIComponent(geo.lat)}&lon=${encodeURIComponent(geo.lon)}`
            : `${WORKER_URL}/v1/weather`;
        }
        const r = await fetch(url, {cache:"no-store"});
        const j = await r.json();
        if(!j.ok) return "Weather lookup failed.";
        const c = j.current||{};
        return `üå§ Weather: ${c.temp_c ?? "?"}¬∞C, wind ${c.wind_speed ?? "?"} m/s, precip ${c.precipitation_mm ?? 0} mm (tz: ${j.where?.timezone||"auto"})`;
      }

      async function callNews(q){
        const r = await fetch(`${WORKER_URL}/v1/news?q=`+encodeURIComponent(q), {cache:"no-store"});
        const j = await r.json();
        if (!j.ok || !Array.isArray(j.items) || !j.items.length) return { html: "<div>No recent headlines found.</div>", bullets: [] };

        const fmt = (iso)=>{
          try {
            const d = new Date(iso || "");
            const diff = (Date.now() - d.getTime())/36e5;
            if (isFinite(diff) && diff < 24) {
              const rel = new Intl.RelativeTimeFormat("en",{numeric:"auto"});
              return rel.format(-Math.round(diff), "hour");
            }
            return new Intl.DateTimeFormat("en", { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" }).format(d);
          } catch { return ""; }
        };

        const bullets = j.items.map(it=>`- ${it.title} (${it.source}${it.iso?`, ${fmt(it.iso)}`:""}) ‚Äî ${it.link}`);
        const itemsHTML = j.items.map(it=>{
          const when = it.iso ? ` ¬∑ <span class="muted">${fmt(it.iso)}</span>` : "";
          const src  = it.source ? ` <span class="muted">(${it.source})</span>` : "";
          const link = it.link ? `<a href="${it.link}" target="_blank" rel="noopener noreferrer">${escapeHTML(it.title)}</a>` : escapeHTML(it.title);
          return `<li style="margin:6px 0 10px 0">${link}${src}${when}</li>`;
        }).join("");

        const html = `
          <div><strong>üì∞ Latest headlines for ‚Äú${escapeHTML(j.query)}‚Äù</strong></div>
          <ul style="padding-left:18px;margin:8px 0 10px 0">${itemsHTML}</ul>
          <div class="row" style="gap:8px;margin-top:4px">
            <button class="btn tiny discuss-news" data-query="${encodeURIComponent(j.query)}">Discuss with Elwyn</button>
          </div>
        `;
        return { html, bullets, topic: j.query };
      }

      async function callSearch(q){
        const r = await fetch(`${WORKER_URL}/v1/search?q=`+encodeURIComponent(q), {cache:"no-store"});
        const j = await r.json();
        if(!j.ok) return "Web search failed or no summary found.";
        const title = j.title ? `${j.title}\n` : "";
        return `üîé ${title}${j.summary || "No summary found."}${j.url?`\n\nMore: ${j.url}`:""}`;
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const text=(box.value||"").trim(); if(!text) return;
        box.value=""; hist.push({role:"user",content:text}); add("user",text); save();

        const thinking=document.createElement("div"); thinking.className="bubble assistant"; thinking.textContent="‚Ä¶thinking‚Ä¶";
        log.appendChild(thinking); log.scrollTop=log.scrollHeight;

        try{
          let toolAns = null;
          if (looksLikeTime(text))         toolAns = await callTime(text);
          else if (looksLikeWeather(text)) toolAns = await callWeather(text);
          else if (looksLikeNews(text))    toolAns = await callNews(text);
          else if (looksLikeSearch(text))  toolAns = await callSearch(text);

          if(toolAns){
            thinking.remove();
            if (typeof toolAns === "object" && toolAns.html){
              addHTML("assistant", toolAns.html);
              document.querySelectorAll(".discuss-news").forEach(btn=>{
                btn.addEventListener("click", async ()=>{
                  const topic = toolAns.topic || decodeURIComponent(btn.getAttribute("data-query")||"news");
                  const condensed = (toolAns.bullets || []).slice(0,6).join("\n");
                  const prompt = `Based on these recent headlines about "${topic}", summarize key takeaways, trends, likely causes, and reasonable implications. Then list 3 follow-up questions I could ask.\n\nHeadlines:\n${condensed}`;
                  hist.push({role:"user", content: prompt}); save(); add("user", prompt);

                  try{
                    const r2 = await fetch(`${WORKER_URL}/v1/chat`, {
                      method:"POST", headers:{ "content-type":"application/json" },
                      body: JSON.stringify({ model: currentModel(), messages: hist })
                    });
                    const j2 = await r2.json().catch(()=>({}));
                    const reply = j2.reply || "(no reply)";
                    hist.push({role:"assistant",content:reply}); save(); add("assistant", reply);
                  }catch(err){
                    add("assistant","Server error: "+(err?.message||err));
                  }
                }, { once:true });
              });
            } else {
              const txt = typeof toolAns === "string" ? toolAns : JSON.stringify(toolAns);
              hist.push({role:"assistant",content:txt}); save(); add("assistant", txt);
            }
            return;
          }
        }catch{}

        // Model chat (no ‚Äú‚Äî via ‚Ä¶‚Äù)
        try{
          const r = await fetch(`${WORKER_URL}/v1/chat`, {
            method:"POST", headers:{ "content-type":"application/json" },
            body: JSON.stringify({ model: currentModel(), messages: hist })
          });
          const j = await r.json().catch(()=>({}));
          const reply = j.reply || "(no reply)";
          thinking.remove(); hist.push({role:"assistant",content:reply}); save(); add("assistant", reply);
        }catch(err){
          thinking.remove(); add("assistant","Server error: "+(err?.message||err));
        }
      });

      // seed geolocation
      (async ()=>{ const existing=localStorage.getItem(geoKey); if(!existing) await updateGeoFromDevice(); })();
    })();

    // === Image (frontend) ===
    (() => {
      const form  = document.getElementById("imgForm");
      const input = document.getElementById("imgPrompt");
      const out   = document.getElementById("imgOut");
      if (!form || !input || !out) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const p = (input.value || "").trim(); if (!p) return;

        out.innerHTML = `<div class="muted">Generating‚Ä¶</div>`;

        const ctl = new AbortController();
        const to  = setTimeout(()=>ctl.abort(), 45000);

        try {
          const r = await fetch(`${WORKER_URL}/v1/image`, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ prompt: p, size: "1024x1024" }),
            signal: ctl.signal
          });
          clearTimeout(to);

          const raw = await r.text();
          let j = {}; try { j = JSON.parse(raw); } catch {
            out.innerHTML = `<div class="muted">Upstream returned non-JSON. Status ${r.status}. Raw: <code>${raw.slice(0,240)}‚Ä¶</code></div>`;
            return;
          }

          if (j?.ok && j.image_b64) {
            const img = new Image();
            img.src = "data:image/png;base64," + j.image_b64;
            img.alt = "generated image";
            img.style.width = "100%";
            img.loading = "lazy";
            out.innerHTML = `<div class="tiny muted">Model: ${j.modelUsed || "unknown"} ‚Ä¢ ${j.size || "1024x1024"}</div>`;
            out.appendChild(img);
            return;
          }

          const msg = j?.error || "Image generation failed";
          const detail = j?.detail ? `<div class="tiny muted">Detail: ${j.detail}</div>` : "";
          out.innerHTML = `<div class="muted">Error: ${msg}</div>${detail}`;
        } catch (err) {
          const aborted = err?.name === "AbortError";
          out.innerHTML = `<div class="muted">${aborted ? "Request timed out (45s)" : "Server error"}: ${err?.message || err}</div>`;
        }
      });
    })();
  </script>
</body>
</html>
